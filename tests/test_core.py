# here all core functions should be tested properly - ideally against FEM

import numpy as np

from magpylib._src.fields.field_BH_current_sheet import BHJM_current_sheet
from magpylib._src.fields.field_BH_sphere import magnet_sphere_Bfield


def test_magnet_sphere_Bfield():
    "magnet_sphere_Bfield test"
    B = magnet_sphere_Bfield(
        observers=np.array([(0, 0, 0)]),
        diameters=np.array([1]),
        polarizations=np.array([(0, 0, 1)]),
    )
    Btest = np.array([(0, 0, 2 / 3)])
    np.testing.assert_allclose(B, Btest)


def test_current_sheet_Bfield():
    "test egainst BEM"

    # test 1

    observers = np.array(
        (
            (
                4.881350392732475285e-01,
                2.151893663724194994e00,
                1.027633760716438971e00,
            ),
            (
                4.488318299689684210e-01,
                -7.634520066109526937e-01,
                1.458941130666561392e00,
            ),
            (
                -6.241278873730751187e-01,
                3.917730007820797056e00,
                4.636627605010293252e00,
            ),
            (
                -1.165584811742222726e00,
                2.917250380826645895e00,
                2.889491975290443548e-01,
            ),
            (
                6.804456109393228758e-01,
                4.255966382926610336e00,
                -4.289639418021130801e00,
            ),
            (
                -4.128707002984592478e00,
                -4.797816025596742584e00,
                3.326198455479380200e00,
            ),
            (2.781567509498504620e00, 3.700121482468190948e00, 4.786183422327640713e00),
            (
                2.991585642167235548e00,
                -3.852063774706815380e-01,
                2.805291762864554173e00,
            ),
            (
                -3.817255741310667805e00,
                1.399210213275238424e00,
                -3.566467125909535962e00,
            ),
            (
                4.446689170495838894e00,
                2.184832175007169752e-01,
                -8.533806000947645742e-01,
            ),
            (
                -1.000000000000000000e00,
                0.000000000000000000e00,
                0.000000000000000000e00,
            ),
            (2.000000000000000000e00, 0.000000000000000000e00, 0.000000000000000000e00),
            (
                0.000000000000000000e00,
                -1.000000000000000000e00,
                0.000000000000000000e00,
            ),
            (0.000000000000000000e00, 2.000000000000000000e00, 0.000000000000000000e00),
            (
                2.000000000000000000e00,
                -1.000000000000000000e00,
                0.000000000000000000e00,
            ),
            (
                -1.000000000000000000e00,
                2.000000000000000000e00,
                0.000000000000000000e00,
            ),
            (
                -1.000000000000000000e00,
                2.000000000000000000e00,
                1.000000000000000000e00,
            ),
            (
                -1.000000000000000000e00,
                2.000000000000000000e00,
                -1.000000000000000000e00,
            ),
        )
    )

    n = len(observers)

    vertices = np.tile(
        np.expand_dims(np.array(((0, 0, 0), (1, 0, 0), (0, 1, 0))), axis=0), (n, 1, 1)
    )
    current_densities = np.tile(np.array((1, 1, 0)).T, (n, 1))

    B_field_current_sheet = BHJM_current_sheet(
        "B",
        observers,
        vertices,
        current_densities,
    )

    B_BEM = -np.array(
        (
            (-5.77021e-09, 5.77021e-09, -8.75240e-09),
            (-1.18724e-08, 1.18724e-08, 9.24139e-09),
            (-1.10847e-09, 1.10847e-09, -1.07797e-09),
            (-5.62891e-10, 5.62891e-10, -7.72038e-09),
            (1.08663e-09, -1.08663e-09, -8.98825e-10),
            (-3.83528e-10, 3.83528e-10, 7.68352e-11),
            (-9.35900e-10, 9.35900e-10, -1.78456e-10),
            (-2.32377e-09, 2.32377e-09, 2.75055e-09),
            (1.03337e-09, -1.03337e-09, -1.49974e-09),
            (5.83738e-10, -5.83738e-10, 2.84827e-09),
            (0.00000e00, 0.00000e00, -1.88245e-08),
            (0.00000e00, 0.00000e00, 2.11957e-08),
            (0.00000e00, 0.00000e00, 1.88245e-08),
            (0.00000e00, 0.00000e00, -2.11957e-08),
            (0.00000e00, 0.00000e00, 1.62116e-08),
            (0.00000e00, 0.00000e00, -1.62116e-08),
            (-4.07319e-09, 4.07319e-09, -1.16537e-08),
            (4.07319e-09, -4.07319e-09, -1.16537e-08),
        )
    )

    np.testing.assert_allclose(B_BEM, B_field_current_sheet, rtol=1e-3)

    # test 2

    observers = np.array(
        (
            (
                1.085110023512870114e00,
                2.601622467210790379e00,
                -9.994281259132755668e-01,
            ),
            (
                5.116628631591988441e-01,
                -2.662205459144347808e-01,
                -5.383070261560110037e-01,
            ),
            (
                -6.869894311164548295e-02,
                7.278036352152388311e-01,
                9.838373711533496824e-01,
            ),
            (1.694083670016784726e00, 1.095972572016473912e00, 2.426097501983797589e00),
            (
                2.226124865758727367e-02,
                3.390587181954726859e00,
                -8.630620340103691834e-01,
            ),
            (2.352337550892011020e00, 1.086524011835634962e00, 1.793449142228758397e00),
            (
                -2.980653070238311608e-01,
                -9.492554575606049205e-03,
                3.003722843377683027e00,
            ),
            (
                3.841307878596987635e00,
                5.671208907962141943e-01,
                2.461613078346570394e00,
            ),
            (
                3.381945761480191770e00,
                3.473033317519236718e00,
                -5.747789431511104441e-01,
            ),
            (
                -8.047260838355881907e-01,
                -1.508479021771554907e-01,
                3.390712517147065341e00,
            ),
            (
                -1.000000000000000000e00,
                0.000000000000000000e00,
                0.000000000000000000e00,
            ),
            (2.000000000000000000e00, 0.000000000000000000e00, 0.000000000000000000e00),
            (
                0.000000000000000000e00,
                -5.000000000000000000e-01,
                0.000000000000000000e00,
            ),
            (4.000000000000000000e00, 1.500000000000000000e00, 0.000000000000000000e00),
            (
                -1.000000000000000000e00,
                -3.333333333333333148e-01,
                0.000000000000000000e00,
            ),
            (4.000000000000000000e00, 1.333333333333333259e00, 0.000000000000000000e00),
            (
                3.000000000000000000e00,
                5.000000000000000000e-01,
                0.000000000000000000e00,
            ),
            (1.000000000000000000e00, 1.000000000000000000e00, 0.000000000000000000e00),
        )
    )

    n = len(observers)

    # coordinates = np.tile(np.array((1,3,1)).T, (n,1))
    # current_densities = np.tile(np.array((0,1)).T, (n,1))
    vertices = np.tile(
        np.expand_dims(np.array(((0, 0, 0), (1, 0, 0), (3, 1, 0))), axis=0), (n, 1, 1)
    )
    current_densities = np.tile(np.array((0, 1, 0)).T, (n, 1))

    B_field_current_sheet = BHJM_current_sheet(
        "B",
        observers,
        vertices,
        current_densities,
    )

    B_BEM = -np.array(
        (
            (2.97753e-09, 0.00000e00, -9.52609e-10),
            (3.54616e-08, 0.00000e00, -1.98893e-08),
            (-1.08746e-08, 0.00000e00, -1.14881e-08),
            (-6.63081e-09, 0.00000e00, 7.76358e-10),
            (1.01150e-09, 0.00000e00, -1.50189e-09),
            (-8.61664e-09, 0.00000e00, 3.69544e-09),
            (-3.72730e-09, 0.00000e00, -1.83084e-09),
            (-3.00527e-09, 0.00000e00, 2.76868e-09),
            (5.83104e-10, 0.00000e00, 1.79762e-09),
            (-2.61711e-09, 0.00000e00, -1.53289e-09),
            (0.00000e00, 0.00000e00, -1.13296e-08),
            (0.00000e00, 0.00000e00, 4.27313e-08),
            (0.00000e00, 0.00000e00, -2.41300e-08),
            (0.00000e00, 0.00000e00, 6.59267e-09),
            (0.00000e00, 0.00000e00, -1.03229e-08),
            (0.00000e00, 0.00000e00, 7.17046e-09),
            (0.00000e00, 0.00000e00, 2.94875e-08),
            (0.00000e00, 0.00000e00, -1.70749e-08),
        )
    )

    np.testing.assert_allclose(B_BEM, B_field_current_sheet, rtol=1e-3)

    # test 3

    observers = np.array(
        (
            (
                1.015958051491509195e00,
                4.162956452362095661e00,
                -4.181905221741113010e00,
            ),
            (
                2.165521039532602998e-01,
                7.858939086953093067e00,
                7.925861778668760849e00,
            ),
            (
                -7.488293790723274945e00,
                -5.855142437236264819e00,
                -8.970655933983401553e00,
            ),
            (
                -1.183803126987271526e00,
                -9.402475782428661333e00,
                -8.633355121057775250e-01,
            ),
            (
                2.982880952295214882e00,
                -4.430254347040493812e00,
                3.525098039602625022e00,
            ),
            (
                1.817256348327017434e00,
                -9.520362352456693600e00,
                1.177081759817639295e00,
            ),
            (
                -4.814951061850692327e00,
                -1.697976059798607551e00,
                -4.329498364573625580e00,
            ),
            (
                3.862758366259926746e00,
                -1.190925646585210274e00,
                -6.862645230500734606e00,
            ),
            (
                8.929803606368942326e-01,
                5.606295290227340189e00,
                -3.872729352476405040e00,
            ),
            (
                -5.560842321356371798e00,
                -2.240574848887025183e00,
                8.727672997208607342e00,
            ),
            (
                -1.600000000000000000e01,
                -1.900000000000000000e01,
                4.000000000000000000e00,
            ),
            (
                1.100000000000000000e01,
                1.700000000000000000e01,
                -1.700000000000000000e01,
            ),
            (5.000000000000000000e00, 2.500000000000000000e01, 1.900000000000000000e01),
            (
                -1.300000000000000000e01,
                -2.300000000000000000e01,
                -1.400000000000000000e01,
            ),
            (
                -4.000000000000000000e00,
                1.300000000000000000e01,
                2.600000000000000000e01,
            ),
            (
                5.000000000000000000e00,
                1.000000000000000000e00,
                -2.800000000000000000e01,
            ),
            (
                -1.000000000000000000e01,
                -3.000000000000000000e00,
                1.500000000000000000e01,
            ),
            (8.000000000000000000e00, 2.100000000000000000e01, 1.000000000000000000e00),
            (
                -4.000000000000000000e00,
                -1.100000000000000000e01,
                -2.100000000000000000e01,
            ),
        )
    )

    n = len(observers)

    # coordinates = np.tile(np.array((1,3,1)).T, (n,1))
    # current_densities = np.tile(np.array((0,1)).T, (n,1))
    vertices = np.tile(
        np.expand_dims(np.array(((2, 5, -10), (-7, -7, -3), (-1, 9, 8))), axis=0),
        (n, 1, 1),
    )
    current_densities = np.tile(
        (np.array((-197796, -222080, 235402)) / 47813).T, (n, 1)
    )

    B_field_current_sheet = BHJM_current_sheet(
        "B",
        observers,
        vertices,
        current_densities,
    )

    print(B_field_current_sheet)

    B_BEM = -np.array(
        (
            (-2.32655e-07, -2.78871e-06, -2.82638e-06),
            (1.24586e-06, -1.43612e-06, -3.08017e-07),
            (-7.13530e-07, 6.14403e-07, -1.99095e-08),
            (-4.44243e-07, -2.12875e-07, -5.74102e-07),
            (-1.02649e-07, -5.68612e-07, -6.22683e-07),
            (-2.53252e-07, -2.64616e-07, -4.62435e-07),
            (-1.13738e-06, 3.41224e-06, 2.26345e-06),
            (-7.47656e-07, -4.03226e-07, -1.00862e-06),
            (7.04419e-07, -3.68089e-06, -2.88070e-06),
            (1.93455e-07, -2.18672e-07, -4.37465e-08),
            (-6.61765e-08, 3.82414e-08, -1.95275e-08),
            (2.69294e-09, -1.55617e-09, 7.94638e-10),
            (1.05467e-07, -6.09462e-08, 3.11215e-08),
            (-1.03676e-07, 5.99114e-08, -3.05930e-08),
            (1.08566e-07, -6.27367e-08, 3.20358e-08),
            (-9.88701e-08, 5.71339e-08, -2.91748e-08),
            (1.02747e-07, -5.93743e-08, 3.03188e-08),
            (1.62315e-07, -9.37968e-08, 4.78962e-08),
            (-1.87278e-07, 1.08222e-07, -5.52625e-08),
        )
    )

    np.testing.assert_allclose(B_BEM, B_field_current_sheet, rtol=5e-2)
